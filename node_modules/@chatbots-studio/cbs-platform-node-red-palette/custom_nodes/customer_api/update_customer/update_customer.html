<script type="text/javascript">
  function resizeDialog(size) {
    size = size || { height: $(".red-ui-tray-content form").height() }
    let rows = $("#dialog-form>div:not(.node-input-property-container-row):visible");
    let height = size.height;
    for (let i = 0; i < rows.length; i++) {
      height -= $(rows[i]).outerHeight(true);
    }
    let editorRow = $("#dialog-form>div.node-input-property-container-row");
    height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
    height += 16;
    $("#node-input-property-container").editableList('height', height);
  }

  const fieldsToInsert = [
    'channel',
    'chatId',
    'email',
    'externalId',
    'firstName',
    'language',
    'lastName',
    'mainProfileId',
    'phone',
    'previousState',
    'previousStateTimestamp',
    'previousTemplateVars',
    'settings',
    'state',
    'stateTimestamp',
    'status',
    'templateVars',
  ];

  RED.nodes.registerType('update-customer', {
    category: 'customerAPI',
    color: '#a7a8e2',
    defaults: {
      channel: { value: '', required: true, validate: RED.validators.typedInput("channelType") },
      channelType: { value: 'msg' },
      chatId: { value: '', required: true, validate: RED.validators.typedInput("chatIdType") },
      chatIdType: { value: 'msg' },
      name: { value: "" },
      payload: { value: "", validate: RED.validators.typedInput("payloadType") },
      payloadType: { value: "str" },
      props: { value: [] },
    },
    inputs: 1,
    outputs: 3,
    icon: "white-globe.png",
    label: function () {
      return this.name || "update-customer";
    },
    oneditprepare: function () {
      $('#node-input-chatId').typedInput({
        default: 'msg',
        types: ['msg'],
        typeField: $('#node-input-chatIdType'),
      });

      $('#node-input-channel').typedInput({
        default: 'msg',
        types: ['msg'],
        typeField: $('#node-input-channelType'),
      });

      const addButton = $("#node-input-new-field-add-button");
      const addButtonWidth = +addButton.outerWidth();
      const select = $(`#node-input-new-field-select`);

      select.css({ width: `calc(100% - ${addButtonWidth}px - 8px)` });

      for (const field of fieldsToInsert) {
        select
          .attr({ disabled: !select[0].children.length })
          .append($("<option></option>")
            .attr({
              id: `node-select-option-${field}`,
              value: field
            })
            .text(field));
      }

      $('#node-input-property-container').css('min-height', '120px').css('min-width', '450px').editableList({
        addButton: false,
        addItem: function (container, i, opt) {
          let prop = opt;
          if (!prop.hasOwnProperty('property')) {
            prop = { property: "", value: "", valueType: "str" };
          }
          container.css({
            overflow: 'hidden',
            whiteSpace: 'nowrap'
          });
          let row = $('<div/>').appendTo(container);

          let propertyName = $('<p/>', {
            class: 'node-input-prop-property-name',
            'data-value': prop.property,
          })
            .css({ width: '30%', display: 'inline-block', padding: "0 6px" })
            .text(fieldsToInsert.find(field => field === prop.property))
            .appendTo(row);

          $(`#node-select-option-${prop.property}`).remove();
          select.attr({ disabled: !select[0].children.length });
          addButton.attr({ disabled: !select[0].children.length });

          let propertyValue = $('<input/>', { class: "node-input-prop-property-value", type: "text" })
            .css("width", "calc(70% - 20px)")
            .appendTo(row)
            .typedInput({
              default: 'str',
              types: ['msg', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date', 'jsonata', 'env']
            });

          propertyName.value = prop.property;
          propertyValue.typedInput('value', prop.value);
          propertyValue.typedInput('type', prop.valueType);
        },
        removeItem: function (item) {
          const option = fieldsToInsert.find(field => field === item.property);

          select
            .attr({ disabled: false })
            .append($("<option></option>")
              .attr({
                id: `node-select-option-${option}`,
                value: option
              })
              .text(option));

          addButton.attr({ disabled: false });
        },
        removable: true,
        sortable: true,
      });

      for (const prop of this.props) {
        $("#node-input-property-container").editableList('addItem', prop);
      }

      addButton.on('click', function () {
        $("#node-input-property-container").editableList('addItem', { property: select.val() });
      });

    },
    oneditsave: function () {
      /* Gather the injected properties of the msg object */
      let props = $("#node-input-property-container").editableList('items');
      let node = this;
      node.props = [];
      delete node.payloadType;
      delete node.payload;
      node.topic = "";
      props.each(function (i) {
        let prop = $(this);
        let p = {
          property: prop.find(".node-input-prop-property-name")[0].dataset.value,
        };
        if (p.property) {
          p.value = prop.find(".node-input-prop-property-value").typedInput('value');
          p.valueType = prop.find(".node-input-prop-property-value").typedInput('type');

          node.props.push(p);
        }
      });
    },
    oneditresize: resizeDialog,
  });
</script>

<script type="text/html" data-template-name="update-customer">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-chatId"><i class="fa fa-id-card"></i> Chat ID</label>
        <input type="text" id="node-input-chatId" style="width: 70%"/>
        <input type="hidden" id="node-input-chatIdType">
    </div>

    <div class="form-row">
        <label for="node-input-channel"><i class="fa fa-id-card"></i> Channel</label>
        <input type="text" id="node-input-channel" style="width: 70%"/>
        <input type="hidden" id="node-input-channelType">
    </div>

    <div class="form-row">
        <label for="node-input-new-field-select"><i class="fa fa-chevron-right"></i> Select field</label>
        <div style="width: 70%; display: inline-block">
            <div style="display: flex; justify-content: space-between">
                <select id="node-input-new-field-select"></select>
                <button id="node-input-new-field-add-button" type="button" class="red-ui-button">
                    <i class="fa fa-plus"></i> Add
                </button>
            </div>
        </div>
    </div>

    <div class="form-row">
        <b>Fields to update:</b>
    </div>

    <div class="form-row node-input-property-container-row">
        <ol id="node-input-property-container"></ol>
    </div>
</script>

<script type="text/html" data-help-name="update-customer">
    <p>Updating Customer information</p>
</script>
